## load macros from other files
#parse("META-INF/templates/labels-vulnerability-assessment/macros/labels.vm")
#parse("META-INF/templates/inventory-report-vulnerability/macros/inventory-report-assets.vm")
##
## main template content
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd">
  #set($templateRegistry = $registry.register("inventory-report-vulnerability", "tpc_inventory-vulnerability-assets"))
#set($topicId = "vulnerability-assets-$reportContext.id")
<topic id="$templateRegistry.registerElement($topicId)">
  #set($assets = $assetAdapter.listAssets())
  #set($atLeastOneAssetWithDetails = false)
    <title>$reportContext.combinedTitle("Affected Assets", true)</title>
    <body>
      #if(!$assets.isEmpty())
        #foreach($asset in $assets)
          #set($assetName = $asset.get("Name"))
          #set($artifacts = $assetAdapter.getRelatedArtifacts($asset))

          #if(!$artifacts.isEmpty())
            #set($vulnerabilitiesForAsset = $vulnerabilityAdapter.getVulnerabilitiesForAsset($asset))

            #if(!$vulnerabilitiesForAsset.isEmpty())
              #set($atLeastOneAssetWithDetails = true)
              #set($topicId = "asset-$assetName")

            <topic id="$topicId">
                <title>"$assetName"</title>
                <section>
                  #set($tableId = "$topicId-affected-components")
                  #componentsInAffectedAssetTable($templateRegistry.registerElement($tableId) $artifacts $assetName)
                </section>
            </topic>
            #end
          #end
        #end
      #end
      #if (!$atLeastOneAssetWithDetails)
      <p>$utils.getText("general.assets-empty")</p>
      #end
    </body>
</topic>
