## load macros from other files
#parse("META-INF/templates/labels-vulnerability-assessment/macros/labels.vm")
#parse("META-INF/templates/inventory-report-vulnerability/macros/inventory-report-vulnerabilities.vm")
##
## main template content
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd">
  #set($templateRegistry = $registry.register("inventory-report-vulnerability", "tpc_inventory-vulnerability-report"))
#set($topicId = "vulnerability-report-$reportContext.id")
<topic id="$templateRegistry.registerElement($topicId)">
    <title>$reportContext.combinedTitle("Vulnerability List", true)</title>
  ##
  #set ($vulnerabilities = $vulnerabilityAdapter.getEffectiveVulnerabilitiesAll())

  ##
  #set ($vulnerabilitiesByStatus = $vulnerabilityAdapter.getVulnerabilitiesByEffectiveStatus($vulnerabilities)) ## Map<DisplayStatusData, List<AeaaVulnerability>> getVulnerabilitiesByEffectiveStatus(List<AeaaVulnerability> vulnerabilities)
  #set ($isAnyCategoryDefined = false)
  #foreach ($status in $vulnerabilitiesByStatus.keySet())
    #if ($vulnerabilitiesByStatus.get($status).size() > 0)
      #set ($isAnyCategoryDefined = true)
    #end
  #end
  ##
    <body>
      #if(!$isAnyCategoryDefined)
      <p>$utils.getText("general.no-vulnerabilites")</p>
      #else
      <p>$utils.getText("inventory-report-vulnerability.defined-vulnerabilites")</p>

#foreach ($status in $vulnerabilitiesByStatus.keySet())
    #if ($vulnerabilitiesByStatus.get($status).size() > 0)
        #set($topicId = "vulnerability-status-${reportContext.id}-$status.getAsXmlId()")

    <topic id="$templateRegistry.registerElement($topicId)">
            <title>$status.getCapitalized()</title>
            <body>
        <p>$utils.getText("inventory-report-vulnerability.vulnerability-status")</p>
        <p>
            #vulnerabilityOverview($templateRegistry.registerElement($status.getAsXmlId()), $templateRegistry,
                "$report.xmlEscapeString($status.getCapitalized()) Category$reportContext.inContextOf()", $vulnerabilitiesByStatus.get($status), $status.shouldModifiedCvssBeDisplayed())
        </p>
            </body>
        </topic>
    #else
        #set($topicId = "vulnerability-status-${reportContext.id}-$status.getAsXmlId()")

    <topic id="$templateRegistry.registerElement($topicId)">
            <title>$status.getCapitalized()</title>
            <body>
        <p>$utils.getText("inventory-report-vulnerability.vulnerability-no-status")</p>
            </body>
        </topic>
    #end
#end
#end
    </body>
</topic>
