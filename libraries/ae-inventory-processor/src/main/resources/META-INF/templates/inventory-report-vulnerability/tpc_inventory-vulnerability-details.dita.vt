#parse("META-INF/templates/labels-vulnerability-assessment/macros/labels.vm")
#parse("META-INF/templates/inventory-report-vulnerability/macros/inventory-report-vulnerabilities.vm")
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd">
  #set($templateRegistry = $registry.register("inventory-report-vulnerability", "tpc_inventory-vulnerability-details"))
#set($topicId = "vulnerability-details-$reportContext.id")
<topic id="$templateRegistry.registerElement($topicId)">
    <title>$reportContext.combinedTitle("Vulnerability Details", true)</title>
  ##
  #set($vulnerabilities = $vulnerabilityAdapter.getEffectiveVulnerabilitiesForDetails())

  ##
  #if($vulnerabilities.isEmpty())
      <body>
      <p>$utils.getText("general.no-vulnerabilites")</p>
      </body>
  #else
      <body>
      <p>$utils.getText("inventory-report-vulnerability.vulnerability-details")</p>
      </body>

    #foreach($vulnerability in $vulnerabilities)
      ##
      #set ($vulnerabilityName = $vulnerability.getId())
      #set ($vulnerabilityNameTextEscaped = $report.xmlEscapeString($vulnerabilityName))
      #set ($vulnerabilityNameIdEscaped = $report.xmlEscapeStringAttribute($vulnerabilityName))
      ##
      #set ($allAdvisories     = $vulnerabilityAdapter.getEffectiveSecurityAdvisoriesForVulnerability($vulnerability))
      #set ($advisoriesAlerts  = $vulnerability.getRelatedAdvisoriesOfType("alert", $allAdvisories))
      #set ($advisoriesNotices = $vulnerability.getRelatedAdvisoriesOfType("notice", $allAdvisories))
      #set ($advisoriesNews    = $vulnerability.getRelatedAdvisoriesOfType("news", $allAdvisories))
      #set ($otherAdvisories   = $vulnerabilityAdapter.getRelatedAdvisoriesExcluding($allAdvisories, $advisoriesAlerts, $advisoriesNotices, $advisoriesNews))
        <topic id="$templateRegistry.registerElement($vulnerabilityName)">
            <title>$vulnerabilityName</title>
            <body>
              ##
            <section>
                <title>$utils.getText("general.short.description")</title>
                <body>
                <p>$report.xmlEscapePreformattedContentString($vulnerability.getDescription())</p>
                </body>
            </section>

            <section>
                <title>$utils.getText("general.short.references")</title>
                <body>
                  #set($tableId = "${vulnerabilityNameIdEscaped}_ref")
                  #referenceTable($templateRegistry.registerElement($tableId),
                    "$vulnerabilityNameTextEscaped" $utils.getText("general.short.references"), $vulnerability)
                </body>
            </section>

              #set($affectedAssets = $vulnerabilityAdapter.getAffectedAssets($vulnerability.getAffectedArtifactsByDefaultKey()))
              #if(!$affectedAssets.isEmpty())
              <section>
                #set($title = "${vulnerabilityNameTextEscaped}" + $utils.getText("general.short.affected-assets"))
                  <title>$title</title>
                  <body>
                    #affectedAssetsTable($templateRegistry.registerElement($title), $vulnerability, $affectedAssets)
                  </body>
              </section>
              #end

            <section>
              #set($title = "${vulnerabilityNameTextEscaped}" + $utils.getText("general.short.affected-components"))
                <title>$title</title>
                <body>
                  #set($affectedComponents = $vulnerability.getAffectedArtifactsByDefaultKey())
                    #affectedComponentsTable($templateRegistry.registerElement($title), $vulnerability, $affectedComponents)
                </body>
            </section>
              ##

              #if ($utils.notEmpty($vulnerability.getCweString()))
              <section>
                  <title>$utils.getText("inventory-report-vulnerability.short.weakness")</title>
                  <body>
                    $report.xmlEscapeString($vulnerability.getCweString())
                  </body>
              </section>
              #end
            <section>
                <title>$utils.getText("inventory-report-vulnerability.short.initial-severity")</title>
                <body>
                  #if ($vulnerability.getCvssSelectionResult().hasInitialCvss())
                    #set($tableId = "${vulnerabilityNameIdEscaped}_severity")
                  <p>
                    #cvssScoreOverviewTable(
                      "$templateRegistry.registerElement($tableId)", "$vulnerabilityNameTextEscaped" $utils.getText(
                      "inventory-report-vulnerability.short.initial-severity"), $vulnerability, false)
                  </p>
                    ##                    <p>
                    ##                        #cvssScoreDetailsTable("${vulnerabilityNameIdEscaped}_severity_details", "$vulnerabilityNameTextEscaped Initial Severity Details", $vulnerability, false)
                    ##                    </p>
                  #else
                  <p>$utils.getText("inventory-report-vulnerability.no-vulnerability-severity-information")</p>
                  #end
                </body>
            </section>

            </body>

          #set($advisoryId = "${vulnerabilityName}-advisories")
            <topic id="$templateRegistry.registerElement($advisoryId)">
                <title>$utils.getText("inventory-report-vulnerability.short.advisories")</title>
                <body>
                  #if ($advisoriesAlerts.isEmpty() && $advisoriesNotices.isEmpty() && $advisoriesNews.isEmpty() && $otherAdvisories.isEmpty())
                  <p>$utils.getText("inventory-report-vulnerability.no-identified-security-advisories")</p>
                  #end
                  #if (!$advisoriesAlerts.isEmpty())
                  <section>
                      <title>$utils.getText("inventory-report-vulnerability.short.alerts")</title>
                    #set($tabledId = "${vulnerabilityNameIdEscaped}_alerts")
                      <p>
                        #advisoryOverview($templateRegistry.registerElement($tabledId),
                          "$vulnerabilityNameTextEscaped" $utils.getText(
                            "inventory-report-vulnerability.short.alerts"), $advisoriesAlerts)
                      </p>
                  </section>
                  #end
                  #if (!$advisoriesNotices.isEmpty())
                  <section>
                      <title>$utils.getText("inventory-report-vulnerability.short.notices")</title>
                    #set($tabledId = "${vulnerabilityNameIdEscaped}_notices")
                      <p>
                        #advisoryOverview($templateRegistry.registerElement($tabledId),
                          "$vulnerabilityNameTextEscaped" $utils.getText(
                            "inventory-report-vulnerability.short.notices"), $advisoriesNotices)
                      </p>
                  </section>
                  #end
                  #if (!$advisoriesNews.isEmpty())
                  <section>
                      <title>$utils.getText("inventory-report-vulnerability.short.updates")</title>
                    #set($tabledId = "${vulnerabilityNameIdEscaped}_updates")
                      <p>
                        #advisoryOverview($templateRegistry.registerElement($tabledId),
                          "$vulnerabilityNameTextEscaped" $utils.getText(
                            "inventory-report-vulnerability.short.updates"), $advisoriesNews)
                      </p>
                  </section>
                  #end
                  #if (!$otherAdvisories.isEmpty())
                  <section>
                      <title>$utils.getText("general.short.other")</title>
                    #set($tabledId = "${vulnerabilityNameIdEscaped}_other_advisories")
                      <p>
                        #advisoryOverview($templateRegistry.registerElement($tabledId),
                          "$vulnerabilityNameTextEscaped" $utils.getText("general.short.other"), $otherAdvisories)
                      </p>
                  </section>
                  #end
                </body>
            </topic>

          #set($assessmentId = "$vulnerability.getId()-assessment")
            <topic id="$templateRegistry.registerElement($assessmentId)">
                <title>$utils.getText("inventory-report-vulnerability.short.assessment")</title>
                <body>
                <section>
                    <title>$utils.getText("general.short.summary")</title>
                    <body>
                    <p>
                      #set ($assessmentSummaryLabels = $vulnerabilityAdapter.getVulnerabilityStatusLabels($vulnerability))
                            #set ($displaySeverity = $vulnerabilityAdapter.shouldDisplayEffectiveVulnerabilityStatusCvssSeverity($vulnerability))
##
                            #foreach ($label in $assessmentSummaryLabels)
                      #labelRef($label)
                    #end
##
                            #if ($displaySeverity)
                      #set ($cvssVector = $vulnerability.getCvssSelectionResult().getSelectedContextIfAvailableOtherwiseInitial())
                      #if ($cvssVector)
                        #labelRef($vulnerabilityAdapter.getSeverityForVectorScore($cvssVector.getOverallScore()).getName())
                      #end
                    #end
                    </p>
                    </body>
                </section>
                  ##
                  #if ($vulnerability.getCvssSelectionResult().hasContextCvss())
                  <section>
                      <title>$utils.getText("inventory-report-vulnerability.short.context-severity")</title>
                      <body>
                        #set($tableId = "${vulnerabilityNameIdEscaped}_modified_severity")

                      <p>
                        #cvssScoreOverviewTable(
                          "$templateRegistry.registerElement($tableId)", "$vulnerabilityNameTextEscaped" $utils.getText(
                          "inventory-report-vulnerability.short.context-severity"), $vulnerability, true)
                      </p>
                      </body>
                  </section>
                    ## Currently not rendering the details; interested parties can use the calculator to see the details.
                    ##                <section>
                    ##                    <title>Context Severity Details</title>
                    ##                    <body>
                    ##                        <p>
                    ##                            #cvssScoreDetailsTable("${vulnerabilityNameIdEscaped}_modified_severity_details", "$vulnerabilityNameTextEscaped Context Severity Details", $vulnerability, true)
                    ##                        </p>
                    ##                    </body>
                    ##                </section>
                  #end

                <section>
                    <title>$utils.getText("inventory-report-vulnerability.short.cvss-severity")</title>
                  #set($tableId = "${vulnerabilityNameIdEscaped}_severity_charts")
                    <body>
                      #cvssScoreChartsTable(
                        "$templateRegistry.registerElement($tableId)", "$vulnerabilityNameTextEscaped" $utils.getText(
                        "inventory-report-vulnerability.short.cvss-severity"), $vulnerability)
                    </body>
                </section>

                  #vulnerabilityStatusDetails($vulnerability)

                </body>
            </topic>

          ## priority section
          #set($priorityId = "$vulnerability.getId()-priority")
            <topic id="$templateRegistry.registerElement($priorityId)">
                <title>$utils.getText("inventory-report-vulnerability.short.priority")</title>
                #set($tabledId = "${vulnerability}-priority-score-table")
                <body>
                  #vulnerabilityPriorityScoreTable($templateRegistry.registerElement($tabledId), $vulnerability, $vulnerabilityAdapter.getSecurityPolicy())
                </body>
            </topic>
        </topic>
    #end
  #end
</topic>
