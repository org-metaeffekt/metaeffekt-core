#parse("META-INF/templates/labels-vulnerability-assessment/macros/labels.vm")
#parse("META-INF/templates/inventory-report-vulnerability/macros/inventory-report-vulnerabilities.vm")
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd">
<topic id="tpc_vulnerability-summary-$reportContext.id">
    <title>$reportContext.combinedTitle("Vulnerability Details", true)</title>
##
#set($vulnerabilities = $vulnerabilityAdapter.getEffectiveVulnerabilitiesForDetails())

##
#if($vulnerabilities.isEmpty())
    <body>
        <p>$utils.getText("general.no-vulnerabilites")</p>
    </body>
#else
    <body>
        <p>$utils.getText("inventory-report-vulnerability.vulnerability-details")</p>
    </body>

#foreach($vulnerability in $vulnerabilities)
##
    #set ($vulnerabilityName = $vulnerability.getId())
    #set ($vulnerabilityNameTextEscaped = $report.xmlEscapeString($vulnerabilityName))
    #set ($vulnerabilityNameIdEscaped = $report.xmlEscapeStringAttribute($vulnerabilityName))
##
    #set ($allAdvisories     = $vulnerabilityAdapter.getEffectiveSecurityAdvisoriesForVulnerability($vulnerability))
    #set ($advisoriesAlerts  = $vulnerability.getRelatedAdvisoriesOfType("alert", $allAdvisories))
    #set ($advisoriesNotices = $vulnerability.getRelatedAdvisoriesOfType("notice", $allAdvisories))
    #set ($advisoriesNews    = $vulnerability.getRelatedAdvisoriesOfType("news", $allAdvisories))
    #set ($otherAdvisories   = $vulnerabilityAdapter.getRelatedAdvisoriesExcluding($allAdvisories, $advisoriesAlerts, $advisoriesNotices, $advisoriesNews))
    <topic id="$vulnerabilityName">
        <title>$vulnerabilityName</title>
        <body>
##
            <section>
                <title>$utils.getText("general.short.description")</title>
                <body>
                    <p>$report.xmlEscapePreformattedContentString($vulnerability.getDescription())</p>
                </body>
            </section>

            <section>
                <title>$utils.getText("general.short.references")</title>
                <body>
                    #referenceTable("${vulnerabilityNameIdEscaped}_ref", "$vulnerabilityNameTextEscaped" $utils.getText("general.short.references"), $vulnerability)
                </body>
            </section>

            #set($affectedAssets = $vulnerabilityAdapter.getAffectedAssets($vulnerability.getAffectedArtifactsByDefaultKey()))
            #if(!$affectedAssets.isEmpty())
            <section>
                <title>$utils.getText("general.short.affected-assets")</title>
                <body>
                    #set($title = "${vulnerabilityNameTextEscaped}" + $utils.getText("general.short.affected-assets"))
                    #affectedAssetsTable($vulnerability, $affectedAssets, $title)
                </body>
            </section>
            #end

            <section>
                <title>$utils.getText("general.short.affected-components")</title>
                <body>
                    #set($affectedComponents = $vulnerability.getAffectedArtifactsByDefaultKey())
                    #set($title = "${vulnerabilityNameTextEscaped}" + $utils.getText("general.short.affected-components"))
                    #affectedComponentsTable($vulnerability, $affectedComponents, $title)
                </body>
            </section>
##

#if ($utils.notEmpty($vulnerability.getCweString()))
            <section>
                <title>$utils.getText("inventory-report-vulnerability.short.weakness")</title>
                <body>
                    $report.xmlEscapeString($vulnerability.getCweString())
                </body>
            </section>
#end
            <section>
                <title>$utils.getText("inventory-report-vulnerability.short.initial-severity")</title>
                <body>
#if ($vulnerability.getCvssSelectionResult().hasInitialCvss())
                    <p>
                        #cvssScoreOverviewTable("${vulnerabilityNameIdEscaped}_severity", "$vulnerabilityNameTextEscaped" $utils.getText("inventory-report-vulnerability.short.initial-severity"), $vulnerability, false)
                    </p>
##                    <p>
##                        #cvssScoreDetailsTable("${vulnerabilityNameIdEscaped}_severity_details", "$vulnerabilityNameTextEscaped Initial Severity Details", $vulnerability, false)
##                    </p>
#else
                    <p>$utils.getText("inventory-report-vulnerability.no-vulnerability-severity-information")</p>
#end
                </body>
            </section>

        </body>

        <topic id="${vulnerabilityName}-advisories">
            <title>$utils.getText("inventory-report-vulnerability.short.advisories")</title>
            <body>
#if ($advisoriesAlerts.isEmpty() && $advisoriesNotices.isEmpty() && $advisoriesNews.isEmpty() && $otherAdvisories.isEmpty())
                <p>$utils.getText("inventory-report-vulnerability.no-identified-security-advisories")</p>
#end
#if (!$advisoriesAlerts.isEmpty())
            <section>
                <title>$utils.getText("inventory-report-vulnerability.short.alerts")</title>
                <p>
#advisoryOverview("${vulnerabilityNameIdEscaped}_alerts", "$vulnerabilityNameTextEscaped" $utils.getText("inventory-report-vulnerability.short.alerts"), $advisoriesAlerts)
                </p>
            </section>
#end
#if (!$advisoriesNotices.isEmpty())
            <section>
                <title>$utils.getText("inventory-report-vulnerability.short.notices")</title>
                <p>
#advisoryOverview("${vulnerabilityNameIdEscaped}_notices", "$vulnerabilityNameTextEscaped" $utils.getText("inventory-report-vulnerability.short.notices"), $advisoriesNotices)
                </p>
            </section>
#end
#if (!$advisoriesNews.isEmpty())
            <section>
                <title>$utils.getText("inventory-report-vulnerability.short.updates")</title>
                <p>
#advisoryOverview("${vulnerabilityNameIdEscaped}_updates", "$vulnerabilityNameTextEscaped" $utils.getText("inventory-report-vulnerability.short.updates"), $advisoriesNews)
                </p>
            </section>
#end
#if (!$otherAdvisories.isEmpty())
            <section>
                <title>$utils.getText("general.short.other")</title>
                <p>
#advisoryOverview("${vulnerabilityNameIdEscaped}_other_advisories", "$vulnerabilityNameTextEscaped" $utils.getText("general.short.other"), $otherAdvisories)
                </p>
            </section>
#end
            </body>
        </topic>
        <topic id="$vulnerability.getId()-assessment">
            <title>$utils.getText("inventory-report-vulnerability.short.assessment")</title>
            <body>
                <section>
                    <title>$utils.getText("general.short.summary")</title>
                    <body>
                        <p>
                            #set ($assessmentSummaryLabels = $vulnerabilityAdapter.getVulnerabilityStatusLabels($vulnerability))
                            #set ($displaySeverity = $vulnerabilityAdapter.shouldDisplayEffectiveVulnerabilityStatusCvssSeverity($vulnerability))
##
                            #foreach ($label in $assessmentSummaryLabels)
                                #labelRef($label)
                            #end
##
                            #if ($displaySeverity)
                                #set ($cvssVector = $vulnerability.getCvssSelectionResult().getSelectedContextIfAvailableOtherwiseInitial())
                                #if ($cvssVector)
                                    #labelRef($vulnerabilityAdapter.getSeverityForVectorScore($cvssVector.getOverallScore()).getName())
                                #end
                            #end
                        </p>
                    </body>
                </section>
##
#if ($vulnerability.getCvssSelectionResult().hasContextCvss())
                <section>
                    <title>$utils.getText("inventory-report-vulnerability.short.context-severity")</title>
                    <body>
                        <p>
                            #cvssScoreOverviewTable("${vulnerabilityNameIdEscaped}_modified_severity", "$vulnerabilityNameTextEscaped" $utils.getText("inventory-report-vulnerability.short.context-severity"), $vulnerability, true)
                        </p>
                    </body>
                </section>
## Currently not rendering the details; interested parties can use the calculator to see the details.
##                <section>
##                    <title>Context Severity Details</title>
##                    <body>
##                        <p>
##                            #cvssScoreDetailsTable("${vulnerabilityNameIdEscaped}_modified_severity_details", "$vulnerabilityNameTextEscaped Context Severity Details", $vulnerability, true)
##                        </p>
##                    </body>
##                </section>
#end

                <section>
                    <title>$utils.getText("inventory-report-vulnerability.short.cvss-severity")</title>
                    <body>
                        #cvssScoreChartsTable("${vulnerabilityNameIdEscaped}_severity_charts", "$vulnerabilityNameTextEscaped" $utils.getText("inventory-report-vulnerability.short.cvss-severity"), $vulnerability)
                    </body>
                </section>

                #vulnerabilityStatusDetails($vulnerability)

            </body>
        </topic>

## priority section
        <topic id="$vulnerability.getId()-priority">
            <title>$utils.getText("inventory-report-vulnerability.short.priority")</title>
            <body>
                #vulnerabilityPriorityScoreTable($vulnerability, $vulnerabilityAdapter.getSecurityPolicy())
            </body>
        </topic>
    </topic>
#end
#end
</topic>
