## load macros from other files
#parse("META-INF/templates/labels-vulnerability-assessment/macros/labels.vm")
#parse("META-INF/templates/inventory-report-vulnerability/macros/inventory-report-vulnerabilities.vm")
##
## main template content
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd">
    #set($templateRegistry = $registry.register("inventory-report-vulnerability", "tpc_inventory-vulnerability-components"))
    #set($topicId = "vulnerability-assets-$reportContext.id")
<topic id="$templateRegistry.registerElement($topicId)">
    <title>$reportContext.combinedTitle("Affected Components", true)</title>
##
#set($components = $vulnerabilityAdapter.getComponentsFromInventory())

##
#set($atLeastOneComponentWithDetails = false)
##
    <body>
        #foreach($component in $components)
            #set($componentEscapedId = $report.xmlEscapeStringAttribute($component))
            #set($artifacts = $vulnerabilityAdapter.getArtifactsForComponent($component))
            #set($vulnerabilitiesForComponent = $vulnerabilityAdapter.getVulnerabilitiesForComponent($component))

            #if (!$vulnerabilitiesForComponent.isEmpty() && !$artifacts.isEmpty())
                #set($atLeastOneComponentWithDetails = true)

                #set($topicId = "component-${componentEscapedId}")
            <topic id="$templateRegistry.registerElement($topicId)">
                <title>$component</title>
                <body>

                    ## section for artifacts with component
                    #if(!$artifacts.isEmpty())
                    <section>
                        <title>Artifacts</title>
                        <body>
                            #set($title = "${component} Affected Artifacts")
                            #affectedComponentsTable($templateRegistry.registerElement($title), "", $artifacts)
                        </body>
                    </section>
                    #end

                    ## section with vulnerabilities for component
                    #if(!$vulnerabilitiesForComponent.isEmpty())
                    <section>
                        <title>$utils.getText("inventory-report-vulnerability.short.vulnerabilites")</title>
                        #set($tableId = "${componentEscapedId}_vulnerabilities")
                        <body>
                            #vulnerabilityOverview($templateRegistry.registerElement($tableId), $templateRegistry, "${component}" $utils.getText("inventory-report-vulnerability.short.vulnerabilites"), $vulnerabilitiesForComponent, true)
                        </body>
                    </section>
                    #end
                </body>
            </topic>
            #end
        #end

        #if(!$atLeastOneComponentWithDetails)
        <p>$utils.getText("general.no-affected-components")</p>
        #end
    </body>
</topic>
