## load macros from other files
#parse("META-INF/templates/labels-vulnerability-assessment/macros/labels.vm")
#parse("META-INF/templates/inventory-report-vulnerability/macros/inventory-report-vulnerabilities.vm")
##
## main template content
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd">
<topic id="tpc_vulnerability-components-$reportContext.id">
    <title>$reportContext.combinedTitle("Affected Components", true)</title>
##
#set($components = $vulnerabilityAdapter.getComponentsFromInventory())

##
#set($atLeastOneComponentWithDetails = false)
##
    <body>
        #foreach($component in $components)
            #set($componentEscapedId = $report.xmlEscapeStringAttribute($component))
            #set($artifacts = $vulnerabilityAdapter.getArtifactsForComponent($component))
            #set($vulnerabilitiesForComponent = $vulnerabilityAdapter.getVulnerabilitiesForComponent($component))

            #if (!$vulnerabilitiesForComponent.isEmpty() && !$artifacts.isEmpty())
                #set($atLeastOneComponentWithDetails = true)

            <topic id="component-$componentEscapedId">
                <title>$component</title>
                <body>

                    ## section for artifacts with component
                    #if(!$artifacts.isEmpty())
                    <section>
                        <title>Artifacts</title>
                        <body>
                            #set($title = "${component} Affected Artifacts")
                            #affectedComponentsTable("", $artifacts, $title)
                        </body>
                    </section>
                    #end

                    ## section with vulnerabilities for component
                    #if(!$vulnerabilitiesForComponent.isEmpty())
                    <section>
                        <title>Vulnerabilities</title>
                        <body>
                            #vulnerabilityOverview("${componentEscapedId}_vulnerabilities", "${component} Vulnerabilities", $vulnerabilitiesForComponent, true)
                        </body>
                    </section>
                    #end
                </body>
            </topic>
            #end
        #end

        #if(!$atLeastOneComponentWithDetails)
        <p>$utils.getText("general.no-affected-components")</p>
        #end
    </body>
</topic>
