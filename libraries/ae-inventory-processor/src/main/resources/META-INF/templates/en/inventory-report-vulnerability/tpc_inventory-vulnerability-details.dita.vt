#parse("META-INF/templates/en/labels-vulnerability-assessment/macros/labels.vm")
#parse("META-INF/templates/en/inventory-report-vulnerability/macros/inventory-report-vulnerabilities.vm")
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd">
<topic id="tpc_vulnerability-summary-$reportContext.id">
    <title>$reportContext.combinedTitle("Vulnerability Details", true)</title>
##
#set($cvssScoringPreference=$report.getCvssScoringPreference())
##
#set($vulnerabilities=$vulnerabilityAdapter.getVulnerabilityMetaDataForDetailReport())
#set($vulnerabilities=$vulnerabilityAdapter.sortVulnerabilitiesByUnmodifiedCvssScore($vulnerabilities))
##
#if($vulnerabilities.isEmpty())
    <body>
        <p>
            No vulnerabilities have been identified.
        </p>
    </body>
#else
    <body>
        <p>
            Details are provided for vulnerabilities which are either potential vulnerabilities or which have
            third-party advisories.
        </p>
    </body>

#foreach($vulnerability in $vulnerabilities)

    #set($vulnerabilityName = $vulnerability.get("Name"))
    #set($advisories        = $vulnerabilityAdapter.getAdvisories($vulnerability))
    #set($alerts            = $vulnerabilityAdapter.filterType($advisories, "alert"))
    #set($notices           = $vulnerabilityAdapter.filterType($advisories, "notice"))
    #set($news              = $vulnerabilityAdapter.filterType($advisories, "news"))

    <topic id="$vulnerabilityName">
        <title>$vulnerabilityName</title>
        <body>

            <section>
                <title>Description</title>
                <body>
                    $report.xmlEscapePreformattedContentString($vulnerability.get("Description"))
                    #referenceTable("${vulnerabilityName}_ref", "$vulnerabilityName References", $vulnerability)
                </body>
            </section>

            <section>
                <title>Affected Components</title>
                <body>
                    #set($affectedComponents=$vulnerabilityAdapter.getAffectedComponents($vulnerability))
                    #set($title = "${vulnerabilityName} Affected Components")
                    #affectedComponentsTable($vulnerability, $affectedComponents, $title)
                </body>
            </section>

#if ($utils.notEmpty($vulnerability.get("Weakness")))
            <section>
                <title>Weakness</title>
                <body>
                    $report.xmlEscapePreformattedContentString($vulnerability.get("Weakness"))
                </body>
            </section>
#end
            <section>
                <title>Severity</title>
                <body>
#if ($utils.notEmpty($vulnerability.get("CVSS Vector (v2)")) || $utils.notEmpty($vulnerability.get("CVSS Vector (v3)")))
                    <p>
                        #cvssScoreOverviewTable("${vulnerabilityName}_severity", "$vulnerabilityName Severity", $vulnerability, false)
                    </p>
                    <p>
                        #cvssScoreDetailsTable("${vulnerabilityName}_severity_details", "$vulnerabilityName Severity Details", $vulnerability, false)
                    </p>
#else
                    <p>
                        The vulnerability does not provide any CVSS severity information.
                    </p>
#end
                </body>
            </section>

        </body>
        <topic id="${vulnerabilityName}-advisories">
            <title>Advisories</title>
            <body>
#if ($alerts.isEmpty() && $notices.isEmpty() && $news.isEmpty())
                <p>
                    No advisories have been identified.
                </p>
#end
#if (!$alerts.isEmpty())
            <section>
                <title>Alerts</title>
                <p>
#advisoryOverview("${vulnerabilityName}_alerts", "$vulnerabilityName Alerts", $alerts)
                </p>
            </section>
#end
#if (!$notices.isEmpty())
            <section>
                <title>Notices</title>
                <p>
#advisoryOverview("${vulnerabilityName}_notices", "$vulnerabilityName Notices", $notices)
                </p>
            </section>
#end
#if (!$news.isEmpty())
            <section>
                <title>Updates</title>
                <p>
#advisoryOverview("${vulnerabilityName}_updates", "$vulnerabilityName Updates", $news)
                </p>
            </section>
#end
            </body>
        </topic>
        <topic id="$vulnerability.get("Name")-assessment">
            <title>Assessment</title>
            <body>
                <section>
                    <title>Summary</title>
                    <body>
                        <p>
                            ## mark items in review (no status yet)
                            #set($displaySeverity=true)
                            #if ($vulnerabilityAdapter.isInReviewVulnerability($vulnerability))
                                #labelRef("In Review")
                            #end
                            ## applicability / status
                            #if ($vulnerabilityAdapter.isApplicableVulnerability($vulnerability))
                                #labelRef("Applicable")
                            #end
                            #if ($vulnerabilityAdapter.isNotApplicableVulnerability($vulnerability))
                                #labelRef("Not Applicable")
                                #set($displaySeverity=false)
                            #end
                            #if ($vulnerabilityAdapter.isInsignificantVulnerability($vulnerability))
                                #labelRef("Insignificant")
                            #end
                            ## vulnerbility highligth / indicate potential risk
                            #if ($vulnerabilityAdapter.isPotentialVulnerability($vulnerability))
                                #labelRef("Potential Risk")
                            #end
                            ## void
                            #if ($vulnerabilityAdapter.isVoidVulnerability($vulnerability))
                                #labelRef("Void Vulnerability")
                                #set($displaySeverity=false)
                            #end
                            ## severity (for selected cases)
                            #if ($displaySeverity)
                                #set($cvssStatusUnmodified = $vulnerabilityAdapter.getUnmodifiedCvssSeverityByScoringPreference($vulnerability, $cvssScoringPreference))
                                #set($cvssStatusModified = $vulnerabilityAdapter.getModifiedCvssSeverityByScoringPreference($vulnerability, $cvssScoringPreference))
                                #if ($utils.notEmpty($cvssStatusModified) && !$cvssStatusModified.equals("N/A"))
                                    #labelRef($cvssStatusModified)
                                #elseif ($utils.notEmpty($cvssStatusUnmodified) && !$cvssStatusUnmodified.equals("N/A"))
                                    #labelRef($cvssStatusUnmodified)
                                #end
                            #end
                        </p>
                    </body>
                </section>

#if ($utils.notEmpty($vulnerability.get("CVSS Modified Vector (v2)")) || $utils.notEmpty($vulnerability.get("CVSS Modified Vector (v3)")))
                <section>
                    <title>Modified Severity</title>
                    <body>
                        <p>
                            #cvssScoreOverviewTable("${vulnerabilityName}_modified_severity", "$vulnerabilityName Modified Severity", $vulnerability, true)
                        </p>
                        <p>
                            #cvssScoreDetailsTable("${vulnerabilityName}_modified_severity_details", "$vulnerabilityName Modified Severity Details", $vulnerability, true)
                        </p>
                    </body>
                </section>
#end

#cvssScoreChartsTable("${vulnerabilityName}_severity_charts", "$vulnerabilityName Severity Charts", $vulnerability)

#if ($utils.notEmpty($vulnerability.get("Rationale")))
                <section>
                    <title>Rationale</title>
                    <body>
                        $report.xmlEscapePreformattedContentString($vulnerability.get("Rationale"))
                    </body>
                </section>
#end

#if ($utils.notEmpty($vulnerability.get("Risk")))
                <section>
                    <title>Risk</title>
                    <body>
                        $report.xmlEscapePreformattedContentString($vulnerability.get("Risk"))
                    </body>
                </section>
#end

#if ($utils.notEmpty($vulnerability.get("Measures")))
                <section>
                    <title>Measures</title>
                    <body>
                        $report.xmlEscapePreformattedContentString($vulnerability.get("Measures"))
                    </body>
                </section>
#end

            </body>
        </topic>
    </topic>
#end
#end
</topic>
