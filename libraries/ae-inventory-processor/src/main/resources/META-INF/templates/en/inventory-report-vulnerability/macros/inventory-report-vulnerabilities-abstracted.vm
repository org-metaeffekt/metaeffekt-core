## do not insert blank lines in between macros. as this document is loaded before the XML tag of the main document,
## this will result in the empty lines appearing at the head of the document, which is not allowed in XML.
##
##
##
#macro (vulnerabilityOverview $id $title $vulnerabilities $includeModifiedSevertiyColumns)
#set ($cvssScoringPreference = $report.getCvssScoringPreference())
##
<table id="$id">
    <title>$title</title>
    #if($includeModifiedSevertiyColumns)
    <tgroup cols="7">
        <colspec colname="COLSPEC0" colnum="1" colwidth="22*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="6*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="9*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="27*" />
        <colspec colname="COLSPEC4" colnum="5" colwidth="11*" />
        <colspec colname="COLSPEC5" colnum="6" colwidth="11*" />
        <colspec colname="COLSPEC6" colnum="7" colwidth="16*" />
    #else
    <tgroup cols="6">
        <colspec colname="COLSPEC0" colnum="1" colwidth="22*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="6*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="9*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="38*" />
        <colspec colname="COLSPEC4" colnum="5" colwidth="11*" />
        <colspec colname="COLSPEC6" colnum="6" colwidth="16*" />
    #end
    <thead>
    <row>
        <entry colname="COLSPEC0" valign="top">Name</entry>
        <entry colname="COLSPEC1" valign="top">Score</entry>
        <entry colname="COLSPEC2" valign="top">Score<sub>mod</sub></entry>
        <entry colname="COLSPEC3" valign="top">$vulnerabilityAdapter.getAdvisoryHeader()</entry>
        <entry colname="COLSPEC4" valign="top">Severity</entry>
        #if ($includeModifiedSevertiyColumns)
            <entry colname="COLSPEC5" valign="top">Severity<sub>mod</sub></entry>
        #end
        <entry colname="COLSPEC6" valign="top">Status</entry>
    </row>
    </thead>

    <tbody>
        #foreach($vulnerability in $vulnerabilities)
        <row>
            <entry>
                #if ($vulnerability.get("Product URIs"))<lines><line><i>$report.xmlEscapeString($vulnerability.get("Product URIs"))</i></line>
                    <line>#if ($vulnerabilityAdapter.hasDetails($vulnerability))<xref href="tpc_inventory-vulnerability-details.dita#$vulnerability.get("Name")" type="topic"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#else<xref href="$vulnerability.get("Url")" type="html" scope="external"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#end</line></lines>
                #else<lines><line>#if ($vulnerabilityAdapter.hasDetails($vulnerability))<xref href="tpc_inventory-vulnerability-details.dita#$vulnerability.get("Name")" type="topic"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#else<xref href="$vulnerability.get("Url")" type="html" scope="external"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#end</line></lines>#end
            </entry>
##
            ## AEAA-242: use the CVSS scoring preference to determine which score to display
            <entry>$vulnerabilityAdapter.getUnmodifiedCvssScoreByScoringPreference($vulnerability, $cvssScoringPreference)</entry>
            <entry>$vulnerabilityAdapter.getModifiedCvssScoreByScoringPreference($vulnerability, $cvssScoringPreference)</entry>
            <entry>$vulnerabilityAdapter.hyperlinkedAdvisories($vulnerabilityAdapter.getAdvisories($vulnerability))</entry>
##
            #set($cvssSeverityUnmodified = $vulnerabilityAdapter.getUnmodifiedCvssSeverityByScoringPreference($vulnerability, $cvssScoringPreference))
            #if ($utils.notEmpty($cvssSeverityUnmodified) && !$cvssSeverityUnmodified.equals("N/A"))
                <entry>#labelRef($cvssSeverityUnmodified)</entry>
            #else
                <entry>&nbsp;</entry>
            #end
##
            ## only include modified severity and vulnerability status (if present) in 'Potential Vulnerabilities' table
            #if ($includeModifiedSevertiyColumns)
                #set($cvssSeverityModified = $vulnerabilityAdapter.getModifiedCvssSeverityByScoringPreference($vulnerability, $cvssScoringPreference))
                #if ($utils.notEmpty($cvssSeverityModified) && !$cvssSeverityModified.equals("N/A"))
                    <entry>#labelRef($cvssSeverityModified)</entry>
                #else
                    <entry>&nbsp;</entry>
                #end
            #end
##
            <entry>
                #labelRef($vulnerabilityAdapter.getStatusText($vulnerability))
            </entry>
##
        </row>
        #end
    </tbody>
</tgroup>
</table>
#end
##
#macro(affectedComponentsTable $vulnerability $affectedComponents $title)
    #if ($affectedComponents.size() > 0)
        #if ($vulnerability)
            #set($vulnerabilityName = $vulnerability.get("Name"))
        #else
            #set($vulnerabilityName = "")
        #end
        #set($containsMsRemediationInformation = $vulnerabilityAdapter.hasVulnerabilityMicrosoftRemediationInformationOnArtifact($vulnerability, $affectedComponents))

        #if($utils.notEmpty($vulnerabilityName))
        <table id="${vulnerabilityName}_affected_components">
        #else
        <table id="$title">
        #end

        <title>$title</title>
        #if($containsMsRemediationInformation)
        <tgroup cols="4">
            <colspec colname="COLSPEC0" colnum="1" colwidth="30*"/>
            <colspec colname="COLSPEC1" colnum="2" colwidth="40*"/>
            <colspec colname="COLSPEC2" colnum="3" colwidth="14*"/>
            <colspec colname="COLSPEC3" colnum="4" colwidth="16*"/>
        #else
        <tgroup cols="3">
            <colspec colname="COLSPEC0" colnum="1" colwidth="40*"/>
            <colspec colname="COLSPEC1" colnum="2" colwidth="46*"/>
            <colspec colname="COLSPEC2" colnum="3" colwidth="14*"/>
        #end

        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Component</entry>
            <entry colname="COLSPEC1" valign="top">Artifact Id</entry>
            <entry colname="COLSPEC2" valign="top">Version</entry>
            #if($containsMsRemediationInformation)
                <entry colname="COLSPEC3" valign="top">MS Remediation</entry>
            #end
        </row>
        </thead>

        <tbody>
            #foreach($artifact in $affectedComponents)
            <row>
                <entry>$report.xmlEscapeString($artifact.get("Component"))</entry>
                <entry>
                    <codeph>$report.xmlEscapeArtifactId($artifact.get("Id"))</codeph>
                </entry>
                <entry>
                    <codeph>$report.xmlEscapeGAV($artifact.get("Version"))</codeph>
                </entry>
                #if($containsMsRemediationInformation)
                    <entry>
                        #set($msRemediationKbIdentifiers=$vulnerabilityAdapter.getMicrosoftRemediationKBsForVulnerabilityOnArtifact($vulnerability, $artifact))
                        #if($msRemediationKbIdentifiers.size() > 0)
                            <p>
                                $report.joinStrings($msRemediationKbIdentifiers, ", ")
                            </p>
                        #end
                        #set($msRemediationUrlDescription=$vulnerabilityAdapter.getMicrosoftRemediationUrlAndDescriptionForVulnerabilityOnArtifact($vulnerability, $artifact))
                        #if($msRemediationUrlDescription.size() > 0)
                            <p>
                                #set($indexCounter=0)
                                #foreach($entry in $msRemediationUrlDescription.entrySet())
## must be lowest indentation, otherwise commas and whitespaces are not rendered correctly
#if ($indexCounter!=0), #end<xref href="$entry.getKey()" type="html" scope="external">$entry.getValue()</xref>
                                    #set($indexCounter=$indexCounter + 1)
                                #end
                            </p>
                        #end
                    </entry>
                #end
            </row>
            #end
        </tbody>
    </tgroup>
    </table>
    #else
        There are no affected components for this vulnerability.
    #end
#end
##