#macro (vulnerabilityOverview $id $title $vulnerabilities $listVulnerabilityStatus)
<table id="$id">
    <title>$title</title>
    #if($listVulnerabilityStatus)
    <tgroup cols="7">
        <colspec colname="COLSPEC0" colnum="1" colwidth="22*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="6*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="9*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="30*" />
        <colspec colname="COLSPEC4" colnum="5" colwidth="11*" />
        <colspec colname="COLSPEC5" colnum="6" colwidth="11*" />
        <colspec colname="COLSPEC6" colnum="7" colwidth="11*" />
    #else
    <tgroup cols="5">
        <colspec colname="COLSPEC0" colnum="1" colwidth="22*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="6*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="9*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="52*" />
        <colspec colname="COLSPEC4" colnum="5" colwidth="11*" />
    #end
        <thead>
            <row>
                <entry colname="COLSPEC0" valign="top">Name</entry>
                <entry colname="COLSPEC1" valign="top">Score</entry>
                <entry colname="COLSPEC2" valign="top">Score<sub>mod</sub></entry>
                <entry colname="COLSPEC3" valign="top">Alerts / Notices / Updates</entry>
                <entry colname="COLSPEC4" valign="top">Severity</entry>
#if($listVulnerabilityStatus)
                <entry colname="COLSPEC5" valign="top">Severity<sub>mod</sub></entry>
                <entry colname="COLSPEC6" valign="top">Status</entry>
#end
            </row>
        </thead>

        <tbody>
#foreach($vulnerability in $vulnerabilities)
            <row>
                <entry>
                    #if ($vulnerability.get("Product URIs"))<lines><line><i>$report.xmlEscapeString($vulnerability.get("Product URIs"))</i></line>
                        <line>#if ($vulnerabilityAdapter.hasDetails($vulnerability, $threshold))<xref href="tpc_inventory-vulnerability-details.dita#$vulnerability.get("Name")" type="topic"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#else<xref href="$vulnerability.get("Url")" type="html" scope="external"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#end</line></lines>
                    #else<lines><line>#if ($vulnerabilityAdapter.hasDetails($vulnerability, $threshold))<xref href="tpc_inventory-vulnerability-details.dita#$vulnerability.get("Name")" type="topic"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#else<xref href="$vulnerability.get("Url")" type="html" scope="external"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#end</line></lines>#end
                </entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Unmodified Overall (max)"))</entry>
#if ($vulnerability.get("CVSS Modified Severity (max)"))
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Modified Overall (max)"))</entry>
#else
                <entry>N/A</entry>
#end
                <entry>$vulnerabilityAdapter.hyperlinkedAdvisories($vulnerabilityAdapter.getAdvisories($vulnerability))</entry>
                <entry>
#if ($vulnerability.get("CVSS Unmodified Severity (max)"))
                    #set($labelText=$vulnerabilityAdapter.modulateSeverityText($vulnerability.get("CVSS Unmodified Severity (max)")))
                    #labelRef($labelText)
#else
                    &nbsp;
#end
                </entry>
#if($listVulnerabilityStatus && $vulnerability.get("Status"))
                <entry>
                    #if ($vulnerability.get("CVSS Modified Severity (max)"))
                        #set($labelText=$vulnerabilityAdapter.modulateSeverityText($vulnerability.get("CVSS Modified Severity (max)")))
                        #labelRef($labelText)
                    #else
                        &nbsp;
                    #end
                </entry>
                <entry>
                    #labelRef("Reviewed")
                </entry>
#elseif($listVulnerabilityStatus)
                <entry>&nbsp;</entry>
                <entry>
                    #labelRef("In Review")
                </entry>
#end
            </row>
#end
        </tbody>
    </tgroup>
</table>
#end
#macro (advisoryOverview $id $title $advisories)
<table id="$id">
    <title>$title</title>
    <tgroup cols="4">
        <colspec colname="COLSPEC0" colnum="1" colwidth="20*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="56*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="12*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="12*" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Id</entry>
            <entry colname="COLSPEC1" valign="top">Summary</entry>
            <entry colname="COLSPEC2" valign="top">Create Date</entry>
            <entry colname="COLSPEC3" valign="top">Update Date</entry>
        </row>
        </thead>
        <tbody>
#foreach($advisory in $advisories)
            <row>
                <entry>$vulnerabilityAdapter.hyperlinkedAdvisory($advisory)</entry>
                <entry>$report.xmlEscapePreformattedContentString($advisory.summary)</entry>
                <entry>$report.xmlEscapeString($advisory.createDate)</entry>
                <entry>$report.xmlEscapeString($advisory.updateDate)</entry>
            </row>
#end
        </tbody>
    </tgroup>
</table>
#end
#macro (referenceTable $id $title $vulnerability)
<table id="$id">
    <title>$title</title>
    <tgroup cols="2">
        <colspec colname="COLSPEC0" colnum="1" colwidth="30*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="80*" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Target</entry>
            <entry colname="COLSPEC1" valign="top">Hyperlink</entry>
        </row>
        </thead>
        <tbody>
#if ($vulnerability.get("Source").equalsIgnoreCase("NVD"))
            <row>
                <entry>NVD</entry>
                <entry><xref href="$vulnerability.get("Url")" type="html" scope="external"/></entry>
            </row>
            <row>
                <entry>MITRE</entry>
                <entry><xref href="https://www.cve.org/CVERecord?id=$vulnerabilityName" type="html" scope="external" /></entry>
            </row>
            <row>
                <entry>CVE Details</entry>
                <entry><xref href="https://www.cvedetails.com/cve/$vulnerabilityName" type="html" scope="external" /></entry>
            </row>
#else
            <row>
                <entry></entry>
                <entry><xref href="$report.xmlEscapePreformattedContentString($vulnerability.get("Url"))" type="html" scope="external" /></entry>
            </row>
#end
        </tbody>
    </tgroup>
</table>
#end
#macro (severityDetails $id $title $vulnerability)
<table id="$id">
    <title>$title</title>
    <tgroup cols="4">
        <colspec colname="COLSPEC0" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="8*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="70*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="12**" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Scheme</entry>
            <entry colname="COLSPEC1" valign="top">Overall</entry>
            <entry colname="COLSPEC2" valign="top">CVSS Vector</entry>
            <entry colname="COLSPEC3" valign="top">Severity</entry>
        </row>
        </thead>
        <tbody>
            <row>
                <entry>CVSS v2.0</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Unmodified Overall (v2)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Vector (v2)"))</codeph></entry>
                <entry>
#if ($vulnerability.get("CVSS Unmodified Severity (v2)"))
                    #set($labelText=$vulnerability.get("CVSS Unmodified Severity (v2)"))
                    #labelRef($labelText)
#else
                    &nbsp;
#end
                </entry>
            </row>
            <row>
                <entry>CVSS v3.x</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Unmodified Overall (v3)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Vector (v3)"))</codeph></entry>
                <entry>
#if ($vulnerability.get("CVSS Unmodified Severity (v3)"))
                    #set($labelText=$vulnerability.get("CVSS Unmodified Severity (v3)"))
                    #labelRef($labelText)
#else
    &nbsp;
#end
                </entry>
            </row>
        </tbody>
    </tgroup>
</table>
#end
#macro (severityDetailsModified $id $title $vulnerability)
#if ($vulnerability.get("CVSS Modified Vector (v2)") || $vulnerability.get("CVSS Modified Vector (v3)"))
<table id="$id">
    <title>$title</title>
    <tgroup cols="4">
        <colspec colname="COLSPEC0" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="8*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="70*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="12**" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Scheme</entry>
            <entry colname="COLSPEC1" valign="top">Overall</entry>
            <entry colname="COLSPEC2" valign="top">CVSS Vector</entry>
            <entry colname="COLSPEC3" valign="top">Severity</entry>
        </row>
        </thead>
        <tbody>
#if ($vulnerability.get("CVSS Modified Vector (v2)"))
            <row>
                <entry>CVSS v2.0</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Modified Overall (v2)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Modified Vector (v2)"))</codeph></entry>
                <entry>
                    #set($labelText=$vulnerability.get("CVSS Modified Severity (v2)"))
                    #labelRef($labelText)
                </entry>
            </row>
#end
#if ($vulnerability.get("CVSS Modified Vector (v3)"))
            <row>
                <entry>CVSS v3.x</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Modified Overall (v3)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Modified Vector (v3)"))</codeph></entry>
                <entry>
                    #set($labelText=$vulnerability.get("CVSS Modified Severity (v3)"))
                    #labelRef($labelText)
                </entry>
            </row>
#end
        </tbody>
    </tgroup>
</table>
#else
<p>
    The provided CVSS vectors have not been modified.
</p>
#end
#end
#macro (severityChartModified $id $title $vulnerability)
#set($vulnerabilityName=$vulnerability.get("Name"))
## the chart is a file in the resources directory
#set($chartFilePath="resources/svg/cvss_modified_${vulnerabilityName}.svg")
#set($chartFileExists=$vulnerabilityAdapter.fileExists("${targetReportDir}/${chartFilePath}"))
## check if no vector, only v2/v3 or both are set
#set($scoreTypeCounts=0)
#if ($vulnerability.get("CVSS Modified Vector (v2)"))
#set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if ($vulnerability.get("CVSS Modified Vector (v3)"))
#set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if($chartFileExists || $scoreTypeCounts > 0)
<table id="$id">
    <title>$title</title>
## chart uses 1 column, scores use 7
#if($chartFileExists && $scoreTypeCounts > 0)
    <tgroup cols="8">
#elseif($chartFileExists)
    <tgroup cols="1">
#elseif($scoreTypeCounts > 0)
    <tgroup cols="7">
#end
#if($scoreTypeCounts > 0)
        <colspec colname="COLSPEC2" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC3" colnum="2" colwidth="7*" />
        <colspec colname="COLSPEC4" colnum="3" colwidth="7*" />
        <colspec colname="COLSPEC5" colnum="4" colwidth="8*" />
        <colspec colname="COLSPEC6" colnum="5" colwidth="8*" />
        <colspec colname="COLSPEC7" colnum="6" colwidth="8*" />
        <colspec colname="COLSPEC8" colnum="7" colwidth="9*" />
#end
#if($chartFileExists)
        <colspec colname="COLSPEC1" colnum="8" colwidth="48**" />
#end
        <thead>
            <row>
#if($scoreTypeCounts > 0)
                <entry colname="COLSPEC2" valign="top">Scheme</entry>
                <entry colname="COLSPEC3" valign="top">Base</entry>
                <entry colname="COLSPEC4" valign="top">Impact</entry>
                <entry colname="COLSPEC5" valign="top">Exploit- ability</entry>
                <entry colname="COLSPEC6" valign="top">Tempo- ral</entry>
                <entry colname="COLSPEC7" valign="top">Environ- mental</entry>
                <entry colname="COLSPEC8" valign="top">Adjusted impact</entry>
#end
#if($chartFileExists)
                <entry colname="COLSPEC1" valign="top">Chart</entry>
#end
            </row>
        </thead>
        <tbody>
#set($useChart=$chartFileExists)
#severityDetailsRow($vulnerability, true, true, $useChart, $chartFilePath)
#set($useChart=$chartFileExists && !$vulnerability.get("CVSS Modified Vector (v2)"))
#severityDetailsRow($vulnerability, false, true, $useChart, $chartFilePath)
            <row><entry></entry><entry></entry><entry></entry><entry></entry><entry></entry><entry></entry><entry></entry></row> ## empty row to allow chart to grow into it
        </tbody>
    </tgroup>
</table>
#end
#end
#macro (severityChartUnmodified $id $title $vulnerability)
#set($vulnerabilityName=$vulnerability.get("Name"))
## the chart is a file in the resources directory
#set($chartFilePath="resources/svg/cvss_unmodified_${vulnerabilityName}.svg")
#set($chartFileExists=$vulnerabilityAdapter.fileExists("${targetReportDir}/${chartFilePath}"))
## check if no vector, only v2/v3 or both are set
#set($scoreTypeCounts=0)
#if ($vulnerability.get("CVSS Vector (v2)"))
    #set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if ($vulnerability.get("CVSS Vector (v3)"))
    #set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if($chartFileExists || $scoreTypeCounts > 0)
<table id="$id">
    <title>$title</title>
    ## chart uses 1 column, scores use 7
#if($chartFileExists && $scoreTypeCounts > 0)
    <tgroup cols="5">
#elseif($chartFileExists)
    <tgroup cols="1">
#elseif($scoreTypeCounts > 0)
    <tgroup cols="4">
#end
#if($scoreTypeCounts > 0)
        <colspec colname="COLSPEC2" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC3" colnum="2" colwidth="8*" />
        <colspec colname="COLSPEC4" colnum="3" colwidth="8*" />
        <colspec colname="COLSPEC5" colnum="4" colwidth="14*" />
#end
#if($chartFileExists)
        <colspec colname="COLSPEC1" colnum="5" colwidth="66**" />
#end
    <thead>
        <row>
#if($scoreTypeCounts > 0)
            <entry colname="COLSPEC2" valign="top">Scheme</entry>
            <entry colname="COLSPEC3" valign="top">Base</entry>
            <entry colname="COLSPEC4" valign="top">Impact</entry>
            <entry colname="COLSPEC5" valign="top">Exploitability</entry>
#end
#if($chartFileExists)
            <entry colname="COLSPEC1" valign="top">Chart</entry>
#end
        </row>
    </thead>
    <tbody>
#set($useChart=$chartFileExists)
#severityDetailsRow($vulnerability, true, false, $useChart, $chartFilePath)
#set($useChart=$chartFileExists && !$vulnerability.get("CVSS Vector (v2)"))
#severityDetailsRow($vulnerability, false, false, $useChart, $chartFilePath)
        <row><entry></entry><entry></entry><entry></entry><entry></entry></row> ## empty row to allow chart to grow into it
    </tbody>
</tgroup>
</table>
#end
#end
#macro(severityDetailsRow $vulnerability $isV2 $isModifiedVector $includeChart $chartFilePath)
#set($modifiedString="")
#if($isModifiedVector)
    #set($modifiedString="Modified ")
#end
#if ($vulnerability.get("CVSS Modified Vector (v2)"))
#end
#if($isV2)
    #set($vectorIdentifierShort="v2")
    #set($vectorIdentifierLong="v2.0")
    #if($includeChart)
        #set($moreRows="2")
    #else
        #set($moreRows="1")
    #end
#else
    #set($vectorIdentifierShort="v3")
    #set($vectorIdentifierLong="v3.x")
    #if($includeChart)
        #set($moreRows="1")
    #else
        #set($moreRows="0")
    #end
#end
<row>
    <entry colname="COLSPEC2" >CVSS $vectorIdentifierLong</entry>
    <entry colname="COLSPEC3" >$report.xmlEscapeString($vulnerability.get("CVSS ${modifiedString}Base (${vectorIdentifierShort})"))</entry>
    <entry colname="COLSPEC4" >$report.xmlEscapeString($vulnerability.get("CVSS ${modifiedString}Exploitability (${vectorIdentifierShort})"))</entry>
    <entry colname="COLSPEC5" >$report.xmlEscapeString($vulnerability.get("CVSS ${modifiedString}Impact (${vectorIdentifierShort})"))</entry>
#if($isModifiedVector)
    <entry colname="COLSPEC6" >$report.xmlEscapeString($vulnerability.get("CVSS Temporal (${vectorIdentifierShort})"))</entry>
    <entry colname="COLSPEC7" >$report.xmlEscapeString($vulnerability.get("CVSS Environmental (${vectorIdentifierShort})"))</entry>
    <entry colname="COLSPEC8" >$report.xmlEscapeString($vulnerability.get("CVSS Adjusted Impact (${vectorIdentifierShort})"))</entry>
#end
#if($includeChart)
        <entry colname="COLSPEC1" morerows="$moreRows">
            <image href="$chartFilePath" width="260" alt="$title" align="center"/>
        </entry>
#end
</row>
#end
#macro(affectedComponentsTable $vulnerability $affectedComponents)
#set($vulnerabilityName=$vulnerability.get("Name"))
#if ($affectedComponents.size() > 0)
#set($containsMsRemediationInformation=$vulnerabilityAdapter.hasVulnerabilityMicrosoftRemediationInformationOnArtifact($vulnerability, $affectedComponents))
<table id="${vulnerabilityName}_affected_components}">
    <title>${vulnerabilityName} Affected Components</title>
#if($containsMsRemediationInformation)
    <tgroup cols="4">
        <colspec colname="COLSPEC0" colnum="1" colwidth="30*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="40*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="14*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="16*" />
#else
    <tgroup cols="3">
        <colspec colname="COLSPEC0" colnum="1" colwidth="40*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="46*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="14*" />
#end
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Component</entry>
            <entry colname="COLSPEC1" valign="top">Artifact Id</entry>
            <entry colname="COLSPEC2" valign="top">Version</entry>
#if($containsMsRemediationInformation)
            <entry colname="COLSPEC3" valign="top">MS Remediation</entry>
#end
        </row>
        </thead>
        <tbody>
            #foreach($artifact in $affectedComponents)
            <row>
                <entry>$report.xmlEscapeString($artifact.get("Component"))</entry>
                <entry><codeph>$report.xmlEscapeArtifactId($artifact.get("Id"))</codeph></entry>
                <entry><codeph>$report.xmlEscapeGAV($artifact.get("Version"))</codeph></entry>
                #if($containsMsRemediationInformation)
                    <entry>
                        #set($msRemediationKbIdentifiers=$vulnerabilityAdapter.getMicrosoftRemediationKBsForVulnerabilityOnArtifact($vulnerability, $artifact))
                        #if($msRemediationKbIdentifiers.size() > 0)
                            <p>
#set($indexCounter=0)
#foreach($kb in $msRemediationKbIdentifiers)
KB$kb
#set($indexCounter=$indexCounter + 1)
#if($indexCounter < $msRemediationKbIdentifiers.size() - 1)
,
#end
#end
                            </p>
                        #end
                        #set($msRemediationUrlDescription=$vulnerabilityAdapter.getMicrosoftRemediationUrlAndDescriptionForVulnerabilityOnArtifact($vulnerability, $artifact))
                        #if($msRemediationUrlDescription.size() > 0)
                            <p>
#set($indexCounter=0)
#foreach($entry in $msRemediationUrlDescription.entrySet())
<xref href="$entry.getKey()" type="html" scope="external">$entry.getValue()</xref>
#set($indexCounter=$indexCounter + 1)
#if($indexCounter < $msRemediationUrlDescription.size() - 1)
,
#end
#end

                </p>
                        #end
                    </entry>
                #end
            </row>
            #end
        </tbody>
    </tgroup>
</table>
#else
There are no affected components for this vulnerability.
#end
#end
#macro (statisticsOverviewTable $id $title $filterCert, $threshold, $adapter)
    #set($overviewTableData=$vulnerabilityAdapter.createStatisticsOverviewTable($filterCert, $threshold, $adapter))
    #if(!$overviewTableData.isEmpty())
    <table id="$id">
        <title>$title</title>
        #set($colWidth=100 / $overviewTableData.getHeaders().size())
        <tgroup cols="$overviewTableData.getHeaders().size()">
            #foreach($header in $overviewTableData.getHeaders())
                #set($colIndex=$overviewTableData.getHeaders().indexOf($header) + 1)
                <colspec colname="COLSPEC$colIndex" colnum="$colIndex" colwidth="$colWidth*" />
            #end

            <thead>
            <row>
                #foreach($header in $overviewTableData.getHeaders())
                    #set($colIndex=$overviewTableData.getHeaders().indexOf($header) + 1)
                    <entry colname="COLSPEC$colIndex" valign="top">$header</entry>
                #end
            </row>
            </thead>

            <tbody>
                #foreach($severityCategory in $overviewTableData.getSeverityCategories())
                <row>
                    <entry>
                        #set($labelText=$vulnerabilityAdapter.modulateSeverityText($severityCategory))
                        #labelRef($labelText)
                    </entry>
                    #foreach($severityCategoryPerCategoryCount in $overviewTableData.getCountsForSeverityCategory($severityCategory))
                        <entry>$severityCategoryPerCategoryCount</entry>
                    #end
                </row>
                #end
            </tbody>
        </tgroup>
    </table>
    #end
#end