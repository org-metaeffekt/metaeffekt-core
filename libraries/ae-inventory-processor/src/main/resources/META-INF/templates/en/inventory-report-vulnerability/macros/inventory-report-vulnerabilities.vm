#macro(label $labeltext $labelColor $width $offset)
<svg-container><svg:svg xmlns:svg="http://www.w3.org/2000/svg" width="${width}px" height="17px">
    <svg:rect x="0" y="0" rx="3" ry="3" width="$width" height="17" style="fill:$labelColor.getBackground()" />
    <svg:text text-anchor="middle" alignment-baseline="central" fill="$labelColor.getForeground()">
        <svg:tspan x="$offset" y="12" font-weight="bold">$labelText</svg:tspan>
    </svg:text>
</svg:svg></svg-container>
#end
#macro (vulnerabilityOverview $id $title $vulnerabilities $listVulnerabilityStatus)
<table id="$id">
    <title>$title</title>
    <tgroup cols="6">
        <colspec colname="COLSPEC0" colnum="1" colwidth="21*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="10*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="9*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="40*" />
        <colspec colname="COLSPEC4" colnum="5" colwidth="12*" />
#if($listVulnerabilityStatus)
    <colspec colname="COLSPEC5" colnum="6" colwidth="10*" />
#end
        <thead>
            <row>
                <entry colname="COLSPEC0" valign="top">Name</entry>
                <entry colname="COLSPEC1" valign="top">Score<sub>unmod</sub></entry>
                <entry colname="COLSPEC2" valign="top">Score<sub>mod</sub></entry>
                <entry colname="COLSPEC3" valign="top">Alerts / Notices / Updates</entry>
                <entry colname="COLSPEC4" valign="top">Severity</entry>
#if($listVulnerabilityStatus)
                <entry colname="COLSPEC5" valign="top">Status</entry>
#end
            </row>
        </thead>

        <tbody>
#foreach($vulnerability in $vulnerabilities)
            <row>
                <entry>
                    #if ($vulnerability.get("Product URIs"))<lines><line><i>$report.xmlEscapeString($vulnerability.get("Product URIs"))</i></line>
                        <line>#if ($vulnerabilityAdapter.hasDetails($vulnerability, $threshold))<xref href="tpc_inventory-vulnerability-details.dita#$vulnerability.get("Name")" type="topic"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#else<xref href="$vulnerability.get("Url")" type="html" scope="external"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#end</line></lines>
                    #else<lines><line>#if ($vulnerabilityAdapter.hasDetails($vulnerability, $threshold))<xref href="tpc_inventory-vulnerability-details.dita#$vulnerability.get("Name")" type="topic"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#else<xref href="$vulnerability.get("Url")" type="html" scope="external"><codeph>$report.xmlEscapeString($vulnerability.get("Name"))</codeph></xref>#end</line></lines>#end
                </entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Unmodified Overall (max)"))</entry>
#if ($vulnerability.get("CVSS Modified Severity (max)"))
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Modified Overall (max)"))</entry>
#else
                <entry>N/A</entry>
#end
                <entry>$vulnerabilityAdapter.hyperlinkedAdvisories($vulnerabilityAdapter.getAdvisories($vulnerability))</entry>
                <entry>
#if ($vulnerability.get("CVSS Modified Severity (max)"))
                    #set($labelText=$vulnerabilityAdapter.modulateSeverityText($vulnerability.get("CVSS Modified Severity (max)")))
                    #set($labelColor=$vulnerabilityAdapter.getLabelColor($vulnerability.get("CVSS Modified Severity Color (max)")))
                    #label($labelText, $labelColor, 56, 28)
#elseif ($vulnerability.get("CVSS Unmodified Severity (max)"))
                    #set($labelText=$vulnerabilityAdapter.modulateSeverityText($vulnerability.get("CVSS Unmodified Severity (max)")))
                    #set($labelColor=$vulnerabilityAdapter.getLabelColor($vulnerability.get("CVSS Unmodified Severity Color (max)")))
                    #label($labelText, $labelColor, 56, 28)
#else
                    &nbsp;
#end
                </entry>
#if($listVulnerabilityStatus && $vulnerability.get("Status"))
                <entry>$report.xmlEscapeString($vulnerability.get("Status"))</entry>
#elseif($listVulnerabilityStatus)
                <entry>in review</entry>
#end
            </row>
#end
        </tbody>
    </tgroup>
</table>
#end
#macro (advisoryOverview $id $title $advisories)
<table id="$id">
    <title>$title</title>
    <tgroup cols="4">
        <colspec colname="COLSPEC0" colnum="1" colwidth="20*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="56*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="12*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="12*" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Id</entry>
            <entry colname="COLSPEC1" valign="top">Summary</entry>
            <entry colname="COLSPEC2" valign="top">Create Date</entry>
            <entry colname="COLSPEC3" valign="top">Update Date</entry>
        </row>
        </thead>
        <tbody>
#foreach($advisory in $advisories)
            <row>
                <entry>$vulnerabilityAdapter.hyperlinkedAdvisory($advisory)</entry>
                <entry>$report.xmlEscapePreformattedContentString($advisory.summary)</entry>
                <entry>$report.xmlEscapeString($advisory.createDate)</entry>
                <entry>$report.xmlEscapeString($advisory.updateDate)</entry>
            </row>
#end
        </tbody>
    </tgroup>
</table>
#end
#macro (referenceTable $id $title $vulnerability)
<table id="$id">
    <title>$title</title>
    <tgroup cols="2">
        <colspec colname="COLSPEC0" colnum="1" colwidth="30*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="80*" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Target</entry>
            <entry colname="COLSPEC1" valign="top">Hyperlink</entry>
        </row>
        </thead>
        <tbody>
#if ($vulnerability.get("Source").equalsIgnoreCase("NVD"))
            <row>
                <entry>NVD</entry>
                <entry><xref href="$vulnerability.get("Url")" type="html" scope="external"/></entry>
            </row>
            <row>
                <entry>MITRE</entry>
                <entry><xref href="https://www.cve.org/CVERecord?id=$vulnerabilityName" type="html" scope="external" /></entry>
            </row>
            <row>
                <entry>CVE Details</entry>
                <entry><xref href="https://www.cvedetails.com/cve/$vulnerabilityName" type="html" scope="external" /></entry>
            </row>
#else
            <row>
                <entry></entry>
                <entry><xref href="$report.xmlEscapePreformattedContentString($vulnerability.get("Url"))" type="html" scope="external" /></entry>
            </row>
#end
        </tbody>
    </tgroup>
</table>
#end
#macro (severityDetails $id $title $vulnerability)
<table id="$id">
    <title>$title</title>
    <tgroup cols="4">
        <colspec colname="COLSPEC0" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="8*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="70*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="12**" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Scheme</entry>
            <entry colname="COLSPEC1" valign="top">Overall</entry>
            <entry colname="COLSPEC2" valign="top">CVSS Vector</entry>
            <entry colname="COLSPEC3" valign="top">Severity</entry>
        </row>
        </thead>
        <tbody>
            <row>
                <entry>CVSS v2.0</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Unmodified Overall (v2)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Vector (v2)"))</codeph></entry>
                <entry>
#if ($vulnerability.get("CVSS Unmodified Severity (v2)"))
                    #set($labelText=$vulnerability.get("CVSS Unmodified Severity (v2)"))
                    #set($labelColor=$vulnerabilityAdapter.getLabelColor($vulnerability.get("CVSS Unmodified Severity Color (v2)")))
                    #label($labelText, $labelColor, 56, 28)
#else
                    &nbsp;
#end
                </entry>
            </row>
            <row>
                <entry>CVSS v3.x</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Unmodified Overall (v3)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Vector (v3)"))</codeph></entry>
                <entry>
#if ($vulnerability.get("CVSS Unmodified Severity (v3)"))
                    #set($labelText=$vulnerability.get("CVSS Unmodified Severity (v3)"))
                    #set($labelColor=$vulnerabilityAdapter.getLabelColor($vulnerability.get("CVSS Unmodified Severity Color (v3)")))
                    #label($labelText, $labelColor, 56, 28)
#else
    &nbsp;
#end
                </entry>
            </row>
        </tbody>
    </tgroup>
</table>
#end
#macro (severityDetailsModified $id $title $vulnerability)
#if ($vulnerability.get("CVSS Modified Vector (v2)") || $vulnerability.get("CVSS Modified Vector (v3)"))
<table id="$id">
    <title>$title</title>
    <tgroup cols="4">
        <colspec colname="COLSPEC0" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC1" colnum="2" colwidth="8*" />
        <colspec colname="COLSPEC2" colnum="3" colwidth="70*" />
        <colspec colname="COLSPEC3" colnum="4" colwidth="12**" />
        <thead>
        <row>
            <entry colname="COLSPEC0" valign="top">Scheme</entry>
            <entry colname="COLSPEC1" valign="top">Overall</entry>
            <entry colname="COLSPEC2" valign="top">CVSS Vector</entry>
            <entry colname="COLSPEC3" valign="top">Severity</entry>
        </row>
        </thead>
        <tbody>
#if ($vulnerability.get("CVSS Modified Vector (v2)"))
            <row>
                <entry>CVSS v2.0</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Modified Overall (v2)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Modified Vector (v2)"))</codeph></entry>
                <entry>
                    #set($labelText=$vulnerability.get("CVSS Modified Severity (v2)"))
                    #set($labelColor=$vulnerabilityAdapter.getLabelColor($vulnerability.get("CVSS Modified Severity Color (v2)")))
                    #label($labelText, $labelColor, 56, 28)
                </entry>
            </row>
#end
#if ($vulnerability.get("CVSS Modified Vector (v3)"))
            <row>
                <entry>CVSS v3.x</entry>
                <entry>$report.xmlEscapeString($vulnerability.get("CVSS Modified Overall (v3)"))</entry>
                <entry><codeph>$report.xmlEscapePreformattedContentString($vulnerability.get("CVSS Modified Vector (v3)"))</codeph></entry>
                <entry>
                    #set($labelText=$vulnerability.get("CVSS Modified Severity (v3)"))
                    #set($labelColor=$vulnerabilityAdapter.getLabelColor($vulnerability.get("CVSS Modified Severity Color (v3)")))
                    #label($labelText, $labelColor, 56, 28)
                </entry>
            </row>
#end
        </tbody>
    </tgroup>
</table>
#else
<p>
    The provided CVSS vectors have not been modified.
</p>
#end
#end
#macro (severityChartModified $id $title $vulnerability)
#set($vulnerabilityName=$vulnerability.get("Name"))
## the chart is a file in the resources directory
#set($chartFilePath="resources/current-inventory/svg/cvss_modified_${vulnerabilityName}.svg")
#set($chartFileExists=$vulnerabilityAdapter.fileExists("${targetReportDir}/${chartFilePath}"))
## check if no vector, only v2/v3 or both are set
#set($scoreTypeCounts=0)
#if ($vulnerability.get("CVSS Modified Vector (v2)"))
#set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if ($vulnerability.get("CVSS Modified Vector (v3)"))
#set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if($chartFileExists || $scoreTypeCounts > 0)
<table id="$id">
    <title>$title</title>
## chart uses 1 column, scores use 7
#if($chartFileExists && $scoreTypeCounts > 0)
    <tgroup cols="8">
#elseif($chartFileExists)
    <tgroup cols="1">
#elseif($scoreTypeCounts > 0)
    <tgroup cols="7">
#end
#if($scoreTypeCounts > 0)
        <colspec colname="COLSPEC2" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC3" colnum="2" colwidth="7*" />
        <colspec colname="COLSPEC4" colnum="3" colwidth="7*" />
        <colspec colname="COLSPEC5" colnum="4" colwidth="8*" />
        <colspec colname="COLSPEC6" colnum="5" colwidth="8*" />
        <colspec colname="COLSPEC7" colnum="6" colwidth="8*" />
        <colspec colname="COLSPEC8" colnum="7" colwidth="9*" />
#end
#if($chartFileExists)
        <colspec colname="COLSPEC1" colnum="8" colwidth="48**" />
#end
        <thead>
            <row>
#if($scoreTypeCounts > 0)
                <entry colname="COLSPEC2" valign="top">Scheme</entry>
                <entry colname="COLSPEC3" valign="top">Base</entry>
                <entry colname="COLSPEC4" valign="top">Impact</entry>
                <entry colname="COLSPEC5" valign="top">Exploit- ability</entry>
                <entry colname="COLSPEC6" valign="top">Tempo- ral</entry>
                <entry colname="COLSPEC7" valign="top">Environ- mental</entry>
                <entry colname="COLSPEC8" valign="top">Adjusted impact</entry>
#end
#if($chartFileExists)
                <entry colname="COLSPEC1" valign="top">Chart</entry>
#end
            </row>
        </thead>
        <tbody>
#if ($vulnerability.get("CVSS Modified Vector (v2)"))
            <row>
                <entry colname="COLSPEC2" >CVSS v2.0</entry>
                <entry colname="COLSPEC3" >$vulnerability.get("CVSS Modified Base (v2)")</entry>
                <entry colname="COLSPEC4" >$vulnerability.get("CVSS Modified Exploitability (v2)")</entry>
                <entry colname="COLSPEC5" >$vulnerability.get("CVSS Modified Impact (v2)")</entry>
                <entry colname="COLSPEC6" >$vulnerability.get("CVSS Temporal (v2)")</entry>
                <entry colname="COLSPEC7" >$vulnerability.get("CVSS Environmental (v2)")</entry>
                <entry colname="COLSPEC8" >$vulnerability.get("CVSS Adjusted Impact (v2)")</entry>
#if($chartFileExists)
#if ($vulnerability.get("CVSS Modified Vector (v3)"))
                <entry colname="COLSPEC1" morerows="1">
#else
                <entry colname="COLSPEC1">
#end
                    <image href="$chartFilePath" width="260" alt="$title" align="center"/>
                </entry>
#end
            </row>
#end
#if ($vulnerability.get("CVSS Modified Vector (v3)"))
            <row>
                <entry colname="COLSPEC2" >CVSS v3.x</entry>
                <entry colname="COLSPEC3" >$vulnerability.get("CVSS Modified Base (v3)")</entry>
                <entry colname="COLSPEC4" >$vulnerability.get("CVSS Modified Exploitability (v3)")</entry>
                <entry colname="COLSPEC5" >$vulnerability.get("CVSS Modified Impact (v3)")</entry>
                <entry colname="COLSPEC6" >$vulnerability.get("CVSS Temporal (v3)")</entry>
                <entry colname="COLSPEC7" >$vulnerability.get("CVSS Environmental (v3)")</entry>
                <entry colname="COLSPEC8" >$vulnerability.get("CVSS Adjusted Impact (v3)")</entry>
#if($chartFileExists && !$vulnerability.get("CVSS Modified Vector (v2)"))
                <entry colname="COLSPEC1">
                    <image href="$chartFilePath" width="260" alt="$title" align="center"/>
                </entry>
#end
            </row>
#end
        </tbody>
    </tgroup>
</table>
#end
#end
#macro (severityChartUnmodified $id $title $vulnerability)
#set($vulnerabilityName=$vulnerability.get("Name"))
## the chart is a file in the resources directory
#set($chartFilePath="resources/current-inventory/svg/cvss_unmodified_${vulnerabilityName}.svg")
#set($chartFileExists=$vulnerabilityAdapter.fileExists("${targetReportDir}/${chartFilePath}"))
## check if no vector, only v2/v3 or both are set
#set($scoreTypeCounts=0)
#if ($vulnerability.get("CVSS Vector (v2)"))
    #set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if ($vulnerability.get("CVSS Vector (v3)"))
    #set($scoreTypeCounts=$scoreTypeCounts + 1)
#end
#if($chartFileExists || $scoreTypeCounts > 0)
<table id="$id">
    <title>$title</title>
    ## chart uses 1 column, scores use 7
#if($chartFileExists && $scoreTypeCounts > 0)
    <tgroup cols="5">
#elseif($chartFileExists)
    <tgroup cols="1">
#elseif($scoreTypeCounts > 0)
    <tgroup cols="4">
#end
#if($scoreTypeCounts > 0)
        <colspec colname="COLSPEC2" colnum="1" colwidth="10*" />
        <colspec colname="COLSPEC3" colnum="2" colwidth="8*" />
        <colspec colname="COLSPEC4" colnum="3" colwidth="8*" />
        <colspec colname="COLSPEC5" colnum="4" colwidth="14*" />
#end
#if($chartFileExists)
        <colspec colname="COLSPEC1" colnum="5" colwidth="66**" />
#end
    <thead>
    <row>
#if($scoreTypeCounts > 0)
            <entry colname="COLSPEC2" valign="top">Scheme</entry>
            <entry colname="COLSPEC3" valign="top">Base</entry>
            <entry colname="COLSPEC4" valign="top">Impact</entry>
            <entry colname="COLSPEC5" valign="top">Exploitability</entry>
#end
#if($chartFileExists)
            <entry colname="COLSPEC1" valign="top">Chart</entry>
#end
    </row>
    </thead>
    <tbody>
#if($scoreTypeCounts == 0)
        <row>
            <entry colname="COLSPEC1">
                <image href="$chartFilePath" width="260" alt="$title" align="center"/>
            </entry>
        </row>
#end
#if ($vulnerability.get("CVSS Vector (v2)"))
        <row>
            <entry colname="COLSPEC2">CVSS v2.0</entry>
            <entry colname="COLSPEC3">$vulnerability.get("CVSS Base (v2)")</entry>
            <entry colname="COLSPEC4">$vulnerability.get("CVSS Exploitability (v2)")</entry>
            <entry colname="COLSPEC5">$vulnerability.get("CVSS Impact (v2)")</entry>
#if($chartFileExists)
#if ($vulnerability.get("CVSS Vector (v3)"))
            <entry colname="COLSPEC1" morerows="1">
#else
            <entry colname="COLSPEC1">
#end
                <image href="$chartFilePath" width="260" alt="$title" align="center"/>
            </entry>
#end
        </row>
#end
#if ($vulnerability.get("CVSS Vector (v3)"))
        <row>
            <entry colname="COLSPEC2">CVSS v3.x</entry>
            <entry colname="COLSPEC3">$vulnerability.get("CVSS Base (v3)")</entry>
            <entry colname="COLSPEC4">$vulnerability.get("CVSS Exploitability (v3)")</entry>
            <entry colname="COLSPEC5">$vulnerability.get("CVSS Impact (v3)")</entry>
#if($chartFileExists && !$vulnerability.get("CVSS Vector (v2)"))
            <entry colname="COLSPEC1">
                <image href="$chartFilePath" width="260" alt="$title" align="center"/>
            </entry>
#end
        </row>
#end
    </tbody>
</tgroup>
</table>
#end
#end
#macro (severityChart $id $title $path)
#if($vulnerabilityAdapter.fileExists("${targetReportDir}/${path}"))
<p>$title</p>
<p>
    <image id="$id" href="$path" width="260" alt="$title" align="center"/>
</p>
#end
#end
#macro (statisticsOverviewTable $id $title $filterCert)
    #set($overviewTableData=$vulnerabilityAdapter.createStatisticsOverviewTable($filterCert))
    #if(!$overviewTableData.isEmpty())
    <table id="$id">
        <title>$title</title>
        #set($colWidth=100 / $overviewTableData.getHeaders().size())
        <tgroup cols="$overviewTableData.getHeaders().size()">
            #foreach($header in $overviewTableData.getHeaders())
                #set($colIndex=$overviewTableData.getHeaders().indexOf($header) + 1)
                <colspec colname="COLSPEC$colIndex" colnum="$colIndex" colwidth="$colWidth*" />
            #end

            <thead>
            <row>
                #foreach($header in $overviewTableData.getHeaders())
                    #set($colIndex=$overviewTableData.getHeaders().indexOf($header) + 1)
                    <entry colname="COLSPEC$colIndex" valign="top">$header</entry>
                #end
            </row>
            </thead>

            <tbody>
                #foreach($severityCategory in $overviewTableData.getSeverityCategories())
                <row>
                    <entry>$severityCategory</entry>
                    #foreach($severityCategoryPerCategoryCount in $overviewTableData.getCountsForSeverityCategory($severityCategory))
                        <entry>$severityCategoryPerCategoryCount</entry>
                    #end
                </row>
                #end
            </tbody>
        </tgroup>
    </table>
    #end
#end