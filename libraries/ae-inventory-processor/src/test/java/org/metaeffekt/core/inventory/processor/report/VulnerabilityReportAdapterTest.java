/*
 * Copyright 2009-2026 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.metaeffekt.core.inventory.processor.report;

import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.metaeffekt.core.inventory.processor.model.Inventory;
import org.metaeffekt.core.inventory.processor.model.VulnerabilityMetaData;
import org.metaeffekt.core.inventory.processor.reader.InventoryReader;
import org.metaeffekt.core.inventory.processor.report.adapter.VulnerabilityReportAdapter;
import org.metaeffekt.core.inventory.processor.report.configuration.CentralSecurityPolicyConfiguration;
import org.metaeffekt.core.inventory.processor.tracker.ProcessorTimeTracker;

import java.io.File;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;

@Slf4j
public class VulnerabilityReportAdapterTest {

    @Test
    public void getFurtherAbstractedVulnerabilityCategoryTest() {
        Assertions.assertEquals(CentralSecurityPolicyConfiguration.VULNERABILITY_STATUS_DISPLAY_MAPPER_ABSTRACTED.getMapper().apply(null), "potentially affected");
        Assertions.assertEquals(CentralSecurityPolicyConfiguration.VULNERABILITY_STATUS_DISPLAY_MAPPER_ABSTRACTED.getMapper().apply(""), "potentially affected");
        Assertions.assertEquals(CentralSecurityPolicyConfiguration.VULNERABILITY_STATUS_DISPLAY_MAPPER_ABSTRACTED.getMapper().apply("in review"), "potentially affected");
        Assertions.assertEquals(CentralSecurityPolicyConfiguration.VULNERABILITY_STATUS_DISPLAY_MAPPER_ABSTRACTED.getMapper().apply(VulnerabilityMetaData.STATUS_VALUE_INSIGNIFICANT), "potentially affected");

        Assertions.assertEquals(CentralSecurityPolicyConfiguration.VULNERABILITY_STATUS_DISPLAY_MAPPER_ABSTRACTED.getMapper().apply(VulnerabilityMetaData.STATUS_VALUE_APPLICABLE), "affected");

        Assertions.assertEquals(CentralSecurityPolicyConfiguration.VULNERABILITY_STATUS_DISPLAY_MAPPER_ABSTRACTED.getMapper().apply(VulnerabilityMetaData.STATUS_VALUE_NOTAPPLICABLE), "not affected");
        Assertions.assertEquals(CentralSecurityPolicyConfiguration.VULNERABILITY_STATUS_DISPLAY_MAPPER_ABSTRACTED.getMapper().apply(VulnerabilityMetaData.STATUS_VALUE_VOID), "not affected");
    }

    @Test
    public void postProcessCvssSourceStringAssessmentTest() {
        final VulnerabilityReportAdapter adapter = new VulnerabilityReportAdapter(new Inventory(), new CentralSecurityPolicyConfiguration());
        Assertions.assertEquals(adapter.postProcessCvssSource("NVD-CNA-NVD"), "NVD-CNA-NVD");
        Assertions.assertEquals(adapter.postProcessCvssSource("NVD-CNA-NVD + Assessment + Assessment-all"), "NVD-CNA-NVD + Assessment");
        Assertions.assertEquals(adapter.postProcessCvssSource("NVD-CNA-NVD + Assessment-all + Assessment-lower"), "NVD-CNA-NVD + Assessment");
    }

    @Test
    public void splitVulnerabilityMatchingSourcesIntoMultipleLines1Test() {
        final List<String> inputLines = Arrays.asList("cpe:/a:apache:log4j:2.14.0", "GHSA [2.13.0.0, 2.15.0.0) org.apache.logging.log4j:log4j-core (Maven)", "NVD cpe:/a:vmware:spring_framework:5.3.14", "this is one long space test1:test2:test3:test4");
        final List<String> expectedLines = Arrays.asList("cpe:/a:apache:log4j:2.14.0", "", "GHSA [2.13.0.0, 2.15.0.0)", "org.apache.logging.log4j:", "log4j-core (Maven)", "", "NVD cpe:/a:vmware:spring_", "framework:5.3.14", "", "this is one long space", "test1:test2:test3:test4");
        final List<String> actualLines = new VulnerabilityReportAdapter(new Inventory(), new CentralSecurityPolicyConfiguration()).splitVulnerabilityMatchingSourcesIntoMultipleLines(inputLines, 20, 28);
        Assertions.assertEquals(expectedLines, actualLines);
    }


    @Test
    public void generateTimestampPropertiesTest() throws IOException {
        final File mergedInventory = new File("src/test/resources/merged-inventories/example-0.1.0-merged.xls");
        final Inventory inventory = new InventoryReader().readInventory(mergedInventory);
        final ProcessorTimeTracker processorTimeTracker = ProcessorTimeTracker.fromInventory(inventory);

        Assertions.assertEquals(3, processorTimeTracker.getEntries().size());

        final VulnerabilityReportAdapter adapter = new VulnerabilityReportAdapter(inventory, new CentralSecurityPolicyConfiguration());
        log.info(adapter.generateEnrichmentTimestampConfigs());
    }

    @Test
    public void generateTimestampProperties020() throws IOException {
        final File mergedInventory = new File("src/test/resources/merged-inventories/example-0.2.0-advised.xls");
        final Inventory inventory = new InventoryReader().readInventory(mergedInventory);

        final VulnerabilityReportAdapter adapter = new VulnerabilityReportAdapter(inventory, new CentralSecurityPolicyConfiguration());
        String s = adapter.generateEnrichmentTimestampConfigs();

        log.info(s);
        Assertions.assertTrue(s.contains("ae.vulnerability.index.date.de=12.12.2025"), s);
        Assertions.assertTrue(s.contains("ae.vulnerability.index.date.en=2025-12-12"), s);
    }

    @Test
    public void generateTimestampProperties030() throws IOException {
        final File mergedInventory = new File("src/test/resources/merged-inventories/example-0.3.0-no-merged.xls");
        final Inventory inventory = new InventoryReader().readInventory(mergedInventory);

        final VulnerabilityReportAdapter adapter = new VulnerabilityReportAdapter(inventory, new CentralSecurityPolicyConfiguration());
        String s = adapter.generateEnrichmentTimestampConfigs();

        log.info(s);
        Assertions.assertTrue(s.contains("ae.vulnerability.cyclonedx.importer.timestamp=n.a"));

        Assertions.assertTrue(s.contains("ae.vulnerability.cyclonedx.importer.date.de=n.a"));
        Assertions.assertTrue(s.contains("ae.vulnerability.cyclonedx.importer.date.en=n.a"));

        Assertions.assertTrue(s.contains("ae.vulnerability.cyclonedx.importer.datetime.de=n.a"));
        Assertions.assertTrue(s.contains("ae.vulnerability.cyclonedx.importer.datetime.en=n.a"));

        Assertions.assertTrue(s.contains("ae.vulnerability.inventory.enrichment.enriched.msrcadvisorindex.date.de=10.12.2025 - 12.12.2025"));

        Assertions.assertTrue(s.contains("ae.vulnerability.index.date.en=2025-12-10 - 2026-01-14"), s);
    }
}